<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¯¶å¯å¤¢æ™‚é˜å¤§äº‚é¬¥ï¼šå…¨å“¡å‡ºæ“Šç‰ˆ</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background-color: #f0f8ff;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            overflow-x: hidden;
            user-select: none;
        }

        /* éŠæˆ²ä¸»å®¹å™¨ */
        #game-container {
            background: white;
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 95%;
            max-width: 500px;
            text-align: center;
            position: relative;
            transition: background 0.5s;
        }

        /* --- é¸è§’ç•«é¢èª¿æ•´ (æ”¹ç‚º 3x3 ç¶²æ ¼) --- */
        .char-select-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        .char-btn {
            padding: 10px; border: 4px solid #ddd; border-radius: 20px; 
            background: white; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center;
            width: auto; /* è‡ªå‹•å¯¬åº¦ */
        }
        .char-btn img { width: 70px; height: 70px; object-fit: contain; }
        .char-btn b { font-size: 1.1rem; margin-top: 5px; }
        .char-btn:active { transform: scale(0.95); }

        /* è§’è‰²ä¸»é¡Œè‰² */
        .theme-snorlax { border-color: #4682B4; background: #E3F2FD; color: #0D47A1; }
        .theme-mew { border-color: #FF69B4; background: #FCE4EC; color: #C2185B; }
        .theme-pikachu { border-color: #FFD700; background: #FFFACD; color: #9A8C00; }
        .theme-eevee { border-color: #A0522D; background: #FAF0E6; color: #8B4513; }
        .theme-alcremie { border-color: #FFB6C1; background: #FFF0F5; color: #C2185B; }
        .theme-terapagos { border-color: #87CEEB; background: #E0F7FA; color: #0277BD; }
        .theme-charizard { border-color: #FF6B35; background: #FFF3E0; color: #E65100; }
        .theme-jirachi { border-color: #FFD700; background: #FFF9C4; color: #F57F17; }
        .theme-riolu { border-color: #4A90E2; background: #E3F2FD; color: #1565C0; }


        /* --- æˆ°é¬¥å ´æ™¯ --- */
        .battle-scene {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: 180px;
            padding: 0 5px;
            margin-bottom: 10px;
            position: relative;
        }

        .character-wrapper {
            position: relative;
            width: 130px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }

        .poke-img {
            width: 110px; height: 110px; object-fit: contain; z-index: 2; transition: transform 0.1s;
        }

        .player-flip { transform: scaleX(-1); }

        /* è¡€æ¢ */
        .hp-bar-frame {
            width: 100%; height: 14px; background: #333; border-radius: 7px;
            border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            overflow: hidden; margin-bottom: 5px; position: relative; z-index: 5;
        }
        .hp-fill {
            height: 100%; background: linear-gradient(90deg, #4caf50, #8bc34a);
            width: 100%; transition: width 0.4s ease-out;
        }
        .hp-text {
            font-size: 0.9rem; font-weight: bold; color: #555; margin-bottom: 2px;
        }

        /* å…‰ç’°èˆ‡ç‰¹æ•ˆ */
        .aura-snorlax { filter: drop-shadow(0 0 8px #2196F3); }
        .aura-mew { filter: drop-shadow(0 0 8px #E91E63); }
        .aura-pikachu { filter: drop-shadow(0 0 8px #FFD700); }
        .aura-eevee { filter: drop-shadow(0 0 8px #A0522D); }
        .aura-alcremie { filter: drop-shadow(0 0 10px #FFB6C1); }
        .aura-terapagos { filter: drop-shadow(0 0 10px #87CEEB); }
        .aura-charizard { filter: drop-shadow(0 0 12px #FF6B35); }
        .aura-jirachi { filter: drop-shadow(0 0 12px #FFD700); }
        .aura-riolu { filter: drop-shadow(0 0 10px #4A90E2); }
        .aura-psyduck { filter: drop-shadow(0 0 8px #FFC107); }
        .filter-hurt { filter: sepia(1) hue-rotate(-50deg) saturate(5) brightness(0.8); }

        /* --- å‹•ç•« Class --- */
        .anim-lunge-right { animation: lungeRight 0.5s ease-in-out; }
        @keyframes lungeRight {
            0% { transform: scaleX(-1) translateX(0) translateY(0) scale(1); }
            30% { transform: scaleX(-1) translateX(-20px) translateY(-10px) scale(1.1); }
            50% { transform: scaleX(-1) translateX(-50px) translateY(0) scale(1.15); }
            70% { transform: scaleX(-1) translateX(-30px) translateY(5px) scale(1.05); }
            100% { transform: scaleX(-1) translateX(0) translateY(0) scale(1); }
        }
        .anim-lunge-left { animation: lungeLeft 0.5s ease-in-out; }
        @keyframes lungeLeft {
            0% { transform: translateX(0) translateY(0) scale(1); }
            30% { transform: translateX(-20px) translateY(-10px) scale(1.1); }
            50% { transform: translateX(-50px) translateY(0) scale(1.15); }
            70% { transform: translateX(-30px) translateY(5px) scale(1.05); }
            100% { transform: translateX(0) translateY(0) scale(1); }
        }
        .anim-hit { animation: hitShake 0.6s ease-in-out; }
        @keyframes hitShake {
            0% { transform: translate(0, 0) rotate(0) scale(1); }
            10% { transform: translate(15px, -10px) rotate(15deg) scale(1.1); }
            20% { transform: translate(-10px, 5px) rotate(-10deg) scale(0.95); }
            30% { transform: translate(8px, -5px) rotate(8deg) scale(1.05); }
            40% { transform: translate(-8px, 3px) rotate(-8deg) scale(0.98); }
            50% { transform: translate(5px, -3px) rotate(5deg) scale(1.02); }
            60% { transform: translate(-5px, 2px) rotate(-5deg) scale(0.99); }
            70% { transform: translate(3px, -1px) rotate(3deg) scale(1.01); }
            80% { transform: translate(-2px, 1px) rotate(-2deg) scale(1); }
            100% { transform: translate(0, 0) rotate(0) scale(1); }
        }
        .anim-knockback { animation: knockback 0.4s ease-out; }
        @keyframes knockback {
            0% { transform: translateX(0) rotate(0); }
            50% { transform: translateX(20px) rotate(10deg); }
            100% { transform: translateX(0) rotate(0); }
        }
        .anim-jump { animation: jump 0.4s ease-out; }
        @keyframes jump {
            0% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-25px) scale(1.1); }
            100% { transform: translateY(0) scale(1); }
        }
        .anim-power-up { animation: powerUp 0.3s ease-out; }
        @keyframes powerUp {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.2); filter: brightness(1.5); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        .projectile {
            position: absolute; font-size: 3rem; top: 45%; left: 25%;
            pointer-events: none; z-index: 10; opacity: 0;
        }
        .anim-shoot { animation: shootObj 0.6s forwards; }
        @keyframes shootObj {
            0% { left: 25%; opacity: 1; transform: scale(0.5); }
            80% { left: 75%; opacity: 1; transform: scale(1.2) rotate(360deg); }
            100% { left: 85%; opacity: 0; transform: scale(1.5); }
        }
        .projectile-enemy {
            position: absolute; font-size: 3rem; top: 45%; right: 25%;
            pointer-events: none; z-index: 10; opacity: 0;
        }
        .anim-shoot-left { animation: shootObjLeft 0.6s forwards; }
        @keyframes shootObjLeft {
            0% { right: 25%; opacity: 1; transform: scale(0.5); }
            80% { right: 75%; opacity: 1; transform: scale(1.2) rotate(-360deg); }
            100% { right: 85%; opacity: 0; transform: scale(1.5); }
        }
        .damage-text {
            position: absolute; color: #d32f2f; font-weight: 900; font-size: 2.5rem;
            text-shadow: 2px 2px 0 #fff, 0 0 5px rgba(0,0,0,0.3);
            pointer-events: none; animation: floatUp 1s forwards; z-index: 20;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.2); }
        }

        /* --- UI --- */
        canvas {
            background: #fff; border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 10px auto; display: block;
            width: 260px; height: 260px;
        }
        .input-area {
            background: rgba(255,255,255,0.85); border: 2px solid #ddd;
            padding: 15px; border-radius: 15px;
        }
        input[type="number"] {
            width: 65px; height: 55px; font-size: 2rem; text-align: center;
            border: 3px solid #555; border-radius: 10px; margin: 0 5px;
            background: #fff; color: #333; font-weight: bold;
        }
        .attack-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            margin-top: 10px; display: none;
        }
        .skill-btn {
            background: #ff5722; color: white; border: 2px solid #bf360c;
            padding: 15px 5px; border-radius: 12px; font-size: 1.1rem; 
            font-weight: 900; cursor: pointer; box-shadow: 0 4px 0 #bf360c;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8); transition: transform 0.1s;
            line-height: 1.3; white-space: normal;
        }
        .skill-btn:active { transform: translateY(4px); box-shadow: none; }
        .skill-btn:nth-child(odd) { background: #009688; border-color: #004d40; box-shadow: 0 4px 0 #004d40; }
        .skill-btn:nth-child(even) { background: #673ab7; border-color: #311b92; box-shadow: 0 4px 0 #311b92; }

        #tutorial-overlay, #end-screen {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 50; border-radius: 20px;
            padding: 20px; box-sizing: border-box;
        }
        .tutorial-content { text-align: left; font-size: 1.1rem; line-height: 1.6; color: #333; }
        .highlight-red { color: #d32f2f; font-weight: bold; }
        .highlight-blue { color: #1976d2; font-weight: bold; }

        .btn-main {
            background: #2196f3; color: white; border: none; padding: 15px 30px;
            border-radius: 50px; font-size: 1.3rem; font-weight: bold;
            cursor: pointer; margin-top: 20px; box-shadow: 0 4px 0 #1565c0; width: 100%;
        }
        .btn-main:active { transform: translateY(4px); box-shadow: none; }
        .hidden { display: none !important; }
        
        /* å€’æ•¸è¨ˆæ™‚å™¨ */
        #countdown-timer {
            position: relative;
            margin: 10px auto;
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
            font-size: 2.5rem;
            font-weight: 900;
            padding: 15px 25px;
            border-radius: 50%;
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.5);
            border: 4px solid white;
            z-index: 30;
            min-width: 80px;
            min-height: 80px;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .countdown-warning { animation: shake 0.3s infinite !important; background: linear-gradient(135deg, #ff0000, #cc0000) !important; }
        @keyframes shake {
            0%, 100% { transform: translateX(0) scale(1.1); }
            25% { transform: translateX(-5px) scale(1.1); }
            75% { transform: translateX(5px) scale(1.1); }
        }
        
        /* é€£æ“Šç³»çµ± */
        #combo-counter {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            z-index: 30;
            display: none;
        }
        .combo-active { display: block !important; animation: comboPop 0.5s ease-out; }
        @keyframes comboPop {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* ç‰¹æ®Šæ•ˆæœ */
        .explosion {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            pointer-events: none;
            z-index: 25;
            animation: explode 0.8s forwards;
        }
        @keyframes explode {
            0% { transform: translate(-50%, -50%) scale(0) rotate(0deg); opacity: 1; }
            30% { transform: translate(-50%, -50%) scale(1.2) rotate(180deg); opacity: 1; }
            60% { transform: translate(-50%, -50%) scale(1.8) rotate(360deg); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(2.5) rotate(540deg); opacity: 0; }
        }
        
        /* èƒŒæ™¯éœ‡å‹•æ•ˆæœ */
        .battle-scene.shake {
            animation: screenShake 0.5s ease-in-out;
        }
        @keyframes screenShake {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-5px, -3px) rotate(-1deg); }
            20% { transform: translate(5px, 3px) rotate(1deg); }
            30% { transform: translate(-4px, -2px) rotate(-0.5deg); }
            40% { transform: translate(4px, 2px) rotate(0.5deg); }
            50% { transform: translate(-3px, -1px) rotate(-0.3deg); }
            60% { transform: translate(3px, 1px) rotate(0.3deg); }
            70% { transform: translate(-2px, 0) rotate(-0.1deg); }
            80% { transform: translate(2px, 0) rotate(0.1deg); }
            90% { transform: translate(-1px, 0); }
        }
        
        /* é–ƒå…‰ç‰¹æ•ˆ */
        .flash-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            pointer-events: none;
            z-index: 15;
            animation: flash 0.3s ease-out;
            border-radius: 20px;
        }
        @keyframes flash {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        /* è¡æ“Šæ³¢æ•ˆæœ */
        .shockwave {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            pointer-events: none;
            z-index: 12;
            animation: shockwaveExpand 0.6s ease-out;
        }
        @keyframes shockwaveExpand {
            0% { width: 20px; height: 20px; opacity: 1; }
            100% { width: 200px; height: 200px; opacity: 0; }
        }
        
        /* ç²’å­æ•ˆæœ */
        .particle {
            position: absolute;
            font-size: 1.5rem;
            pointer-events: none;
            z-index: 14;
            animation: particleFloat 1s ease-out forwards;
        }
        @keyframes particleFloat {
            0% { opacity: 1; transform: translate(0, 0) scale(1) rotate(0deg); }
            100% { opacity: 0; transform: translate(var(--tx, 0), var(--ty, -50px)) scale(0.5) rotate(360deg); }
        }
        
        /* æ”»æ“Šé å‚™å‹•ä½œ */
        .anim-ready { animation: readyStance 0.3s ease-out; }
        @keyframes readyStance {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        
        /* ç­”é¡Œå€åŸŸå¢å¼· */
        .input-area {
            position: relative;
        }
        .time-bonus {
            position: absolute;
            top: -30px;
            right: 0;
            color: #4caf50;
            font-weight: 900;
            font-size: 1.5rem;
            animation: bonusFloat 1s forwards;
            display: none;
        }
        @keyframes bonusFloat {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-30px); }
        }
    </style>
</head>
<body>

<div id="game-container">

    <div id="scene-select">
        <h1>ğŸ”¥ å¯¶å¯å¤¢æ™‚é˜å¤§äº‚é¬¥ ğŸ”¥</h1>
        <p>é¸æ“‡ä½ çš„æˆ°å£«ï¼š</p>
        <div class="char-select-grid">
            <button class="char-btn theme-snorlax" onclick="initGame('snorlax')">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/143.gif" alt="å¡æ¯”ç¸">
                <b>å¡æ¯”ç¸</b>
            </button>
            <button class="char-btn theme-mew" onclick="initGame('mew')">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/151.gif" alt="å¤¢å¹»">
                <b>å¤¢å¹»</b>
            </button>
            <button class="char-btn theme-pikachu" onclick="initGame('pikachu')">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/25.gif" alt="çš®å¡ä¸˜">
                <b>çš®å¡ä¸˜</b>
            </button>
            <button class="char-btn theme-eevee" onclick="initGame('eevee')">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/133.gif" alt="ä¼Šå¸ƒ">
                <b>ä¼Šå¸ƒ</b>
            </button>
            <button class="char-btn theme-alcremie" onclick="initGame('alcremie')">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/869.gif" alt="éœœå¥¶ä»™">
                <b>éœœå¥¶ä»™</b>
            </button>
            <button class="char-btn theme-terapagos" onclick="initGame('terapagos')">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/1024.png" alt="å¤ªæ¨‚å·´æˆˆæ–¯" onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/1024.png'">
                <b>å¤ªæ¨‚å·´æˆˆæ–¯</b>
            </button>
            <button class="char-btn theme-charizard" onclick="initGame('charizard')">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/6.gif" alt="å™´ç«é¾">
                <b>å™´ç«é¾</b>
            </button>
            <button class="char-btn theme-jirachi" onclick="initGame('jirachi')">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/385.gif" alt="åŸºæ‹‰ç¥ˆ">
                <b>åŸºæ‹‰ç¥ˆ</b>
            </button>
            <button class="char-btn theme-riolu" onclick="initGame('riolu')">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/447.gif" alt="åˆ©æ­è·¯">
                <b>åˆ©æ­è·¯</b>
            </button>
        </div>
    </div>

    <div id="scene-game" class="hidden">
        <div id="combo-counter">é€£æ“Š x<span id="combo-count">0</span></div>
        
        <div class="battle-scene">
            <div class="character-wrapper">
                <div class="hp-text">ä½ </div>
                <div class="hp-bar-frame"><div id="hp-player" class="hp-fill"></div></div>
                <img id="char-player-img" class="poke-img player-flip" src="" alt="Player">
                <div id="player-projectile" class="projectile">ğŸ’¨</div>
            </div>

            <div style="font-weight:900; font-size:2rem; color:#ddd; padding-bottom:40px;">VS</div>

            <div class="character-wrapper">
                <div class="hp-text">å¯é”é´¨</div>
                <div class="hp-bar-frame"><div id="hp-enemy" class="hp-fill" style="background: linear-gradient(90deg, #ff5252, #d32f2f);"></div></div>
                <img id="char-enemy-img" class="poke-img aura-psyduck" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/54.gif" alt="Psyduck">
                <div id="enemy-projectile" class="projectile-enemy">ğŸ’§</div>
                <div id="damage-popup" class="damage-text" style="display:none; top: 20%; right: 10%;">-25</div>
            </div>
        </div>

        <div id="battle-log" style="min-height:40px; color:#333; font-weight:bold; margin-bottom:5px; background:#fff; padding:5px; border-radius:10px; border:1px solid #ddd;">
            æˆ°é¬¥é–‹å§‹ï¼é¸æ“‡ä½ çš„å¯¶å¯å¤¢ï¼
        </div>

        <div id="quiz-section">
            <div id="countdown-timer">30</div>
            <canvas id="clockCanvas" width="300" height="300"></canvas>
            
            <div class="input-area">
                <div id="time-bonus" class="time-bonus">+æ™‚é–“çå‹µï¼</div>
                <div id="input-controls">
                    <input type="number" id="in-hour" placeholder="æ™‚" min="1" max="12"> :
                    <input type="number" id="in-min" placeholder="åˆ†" min="0" max="59">
                    <br><br>
                    <button onclick="checkAnswer()" class="btn-main" style="margin-top:0;">æ”»æ“Šï¼</button>
                </div>

                <div id="attack-grid" class="attack-grid"></div>
                
                <button id="next-btn" class="btn-main" style="display:none;" onclick="nextRound()">ä¸‹ä¸€é¡Œ</button>
            </div>
        </div>

        <div id="tutorial-overlay">
            <h2 style="color:#d32f2f;">ğŸ¤• å“å‘€ï¼çœ‹éŒ¯äº†ï¼</h2>
            <div id="tutorial-text" class="tutorial-content"></div>
            <button class="btn-main" style="background:#4caf50;" onclick="closeTutorial()">æˆ‘çŸ¥é“äº†ï¼Œå†è©¦ä¸€æ¬¡ï¼</button>
        </div>
    </div>

    <div id="end-screen">
        <h1 id="end-title"></h1>
        <img id="end-img" style="width:150px; height:150px;" src="" alt="Win/Lose">
        <p id="end-desc" style="font-size:1.2rem; font-weight:bold;"></p>
        <button class="btn-main" onclick="location.reload()">å†ä¾†ä¸€å ´</button>
    </div>

</div>

<script>
    // --- åœ–ç‰‡è³‡æº (æ–°å¢åŸºæ‹‰ç¥ˆå’Œåˆ©æ­è·¯) ---
    const IMGS = {
        snorlax: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/143.gif",
        mew: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/151.gif",
        pikachu: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/25.gif",
        eevee: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/133.gif",
        alcremie: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/869.gif",
        terapagos: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/1024.png",
        charizard: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/6.gif",
        jirachi: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/385.gif",
        riolu: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/447.gif",
        psyduck: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/54.gif",
        win: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png",
        lose: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png"
    };

    // --- æ“´å……åˆ° 28 å€‹æç¬‘æ”»æ“Šæ‹›å¼åº« ---
    const ATTACK_POOL = [
        // åŸæœ‰ 20 å€‹
        { id: 1, name: 'ğŸ’¨ é€£ç’°è‡­å±', icon: 'ğŸ’¨', msg: 'ä½ æ”¾äº†ä¸€å€‹è¶…ç´šéŸ¿å±ï¼å¯é”é´¨è¢«è‡­æšˆäº†ï¼' },
        { id: 2, name: 'ğŸ¤£ æ”ç™¢æ”»æ“Š', icon: 'ğŸ‘', msg: 'ä½ å·è¥²å¯é”é´¨çš„èƒ³è‚¢çª©ï¼ä»–ç¬‘åˆ°åœ¨åœ°ä¸Šæ‰“æ»¾ï¼' },
        { id: 3, name: 'ğŸ¤ª æ‰®é¬¼è‡‰', icon: 'ğŸ¤¡', msg: 'ä½ åšäº†ä¸€å€‹è¶…é†œçš„é¬¼è‡‰ï¼å¯é”é´¨åš‡å‘†äº†ï¼' },
        { id: 4, name: 'ğŸ¦µ æ‘³è…³çš®å½ˆå°„', icon: 'ğŸ¥', msg: 'ä½ æŠŠé™³å¹´è…³çš®å½ˆå‡ºå»ï¼ç²¾æº–å‘½ä¸­å¯é”é´¨çš„é¼»å­”ï¼' }, 
        { id: 5, name: 'ğŸ’¤ éœ‡å¤©æ‰“å‘¼', icon: 'ğŸ”Š', msg: 'ä½ çš„æ‰“å‘¼è²åƒæ‰“é›·ä¸€æ¨£ï¼éœ‡ç ´äº†å¯é”é´¨çš„è€³è†œï¼' },
        { id: 6, name: 'ğŸ¦¶ ç„¡æ•µè‡­è…³ä¸«', icon: 'ğŸ¤¢', msg: 'ä½ ä¼¸å‡ºæ²’æ´—çš„è‡­è…³ï¼é€™å‘³é“æ¯”åƒåœ¾è»Šé‚„å¯æ€•ï¼' },
        { id: 7, name: 'ğŸ¦  å·¨å¤§é¼»å±', icon: 'â˜ï¸', msg: 'ä½ æŒ–å‡ºä¸€é¡†ç‰¹å¤§è™Ÿé¼»å±ï¼Œé»åœ¨å¯é”é´¨é ­ä¸Šï¼' },
        { id: 8, name: 'ğŸ‘ å±è‚¡æ’æ“Š', icon: 'ğŸ’¥', msg: 'ä½ ç”¨å±è‚¡ç”¨åŠ›æ’é£›å¯é”é´¨ï¼å¥½æœ‰å½ˆæ€§å•Šï¼' },
        { id: 9, name: 'ğŸ˜­ è€è³´æ‰“æ»¾', icon: 'ğŸ›Œ', msg: 'ä½ èººåœ¨åœ°ä¸Šå¤§å“­æ‰“æ»¾ï¼å¯é”é´¨è¦ºå¾—å¾ˆå°·å°¬...' },
        { id: 10, name: 'ğŸ¤ èƒ–è™æ­Œè²', icon: 'ğŸ¤', msg: 'ä½ é–‹å§‹å”±è¶…é›£è½çš„æ­Œï¼å¯é”é´¨ç—›è‹¦åœ°æ‘€ä½è€³æœµï¼' },
        { id: 11, name: 'ğŸŒ é¦™è•‰çš®é™·é˜±', icon: 'ğŸŒ', msg: 'ä½ ä¸Ÿå‡ºé¦™è•‰çš®ï¼å¯é”é´¨è¸©åˆ°æ»‘äº†ä¸€å¤§è·¤ï¼' },
        { id: 12, name: 'â„ï¸ æ€¥å‡å†·ç¬‘è©±', icon: 'â›„', msg: 'ä½ èªªäº†ä¸€å€‹è¶…å†·çš„ç¬‘è©±ï¼ç©ºæ°£ç¬é–“çµå†°äº†ï¼' },
        { id: 13, name: 'ğŸ‘™ å·ç©¿å…§è¤²', icon: 'ğŸ©²', msg: 'ä½ æŠŠå…§è¤²å¥—åœ¨é ­ä¸Šè¡éå»ï¼å¯é”é´¨è¢«ä½ çš„é€ å‹åš‡å‚»äº†ï¼' },
        { id: 14, name: 'ğŸ’‹ å™å¿ƒé£›å»', icon: 'ğŸ’‹', msg: 'ä½ é€å‡ºå……æ»¿å£æ°´çš„é£›å»ï¼å¯é”é´¨è¦ºå¾—è¶…å™å¿ƒï¼' },
        { id: 15, name: 'ğŸ¤ æè‡‰é °', icon: 'ğŸ¤', msg: 'ä½ ç”¨åŠ›æå¯é”é´¨çš„è‡‰é °ï¼è‡‰éƒ½è¢«æ‹‰é•·äº†ï¼' },
        { id: 16, name: 'ğŸ“– ç„¡èŠæ•…äº‹', icon: 'ğŸ¥±', msg: 'ä½ é–‹å§‹è¬›æ•¸å­¸èª²çš„æ•…äº‹... å¯é”é´¨ç¡è‘—äº†ï¼' },
        { id: 17, name: 'ğŸ’¦ åå£æ°´', icon: 'ğŸ’¦', msg: 'å‘¸ï¼ä½ åäº†ä¸€å£å£æ°´ï¼å¾ˆä¸è¡›ç”Ÿä½†å¾ˆæœ‰æ•ˆï¼' },
        { id: 18, name: 'ğŸ–ï¸ äº‚ç•«è‡‰', icon: 'ğŸ–ï¸', msg: 'ä½ æ‹¿å‡ºå½©è‰²ç­†åœ¨å¯é”é´¨è‡‰ä¸Šç•«äº†ä¸€éš»çƒé¾œï¼' },
        { id: 19, name: 'ğŸ© å·åƒé›¶é£Ÿ', icon: 'ğŸ©', msg: 'ä½ æ¶èµ°å¯é”é´¨çš„é¤…ä¹¾åƒæ‰ï¼ä»–çš„å¿ƒç¢äº†ï¼' },
        { id: 20, name: 'ğŸ‘ƒ é¼»æ¯›æ”»æ“Š', icon: 'ã€°ï¸', msg: 'ä½ æ‹”ä¸‹ä¸€å¤§æŠŠé¼»æ¯›ç”©éå»ï¼é€™æ˜¯ä»€éº¼å¥‡æ€ªçš„æ‹›å¼ï¼Ÿï¼' },
        // æ–°å¢ 8 å€‹
        { id: 21, name: 'ğŸ€ çš®çƒæ”»æ“Š', icon: 'ğŸ€', msg: 'ä½ ä¸Ÿå‡ºä¸€é¡†è¶…æœ‰å½ˆæ€§çš„çš®çƒï¼åœ¨å¯é”é´¨è‡‰ä¸Šå½ˆäº†åä¸‹ï¼' },
        { id: 22, name: 'ğŸ˜­ å¤§å“­æ”»æ“Š', icon: 'ğŸŒŠ', msg: 'ä½ å¼µå¤§å˜´å·´å“‡å“‡å¤§å“­ï¼çœ¼æ·šåƒå™´æ³‰ä¸€æ¨£å™´å‘å¯é”é´¨ï¼' },
        { id: 23, name: 'ğŸ é³³æ¢¨é…¥æ”»æ“Š', icon: 'ğŸ', msg: 'ä½ å¡äº†ä¸€å¡Šè¶…ç”œçš„é³³æ¢¨é…¥åˆ°å¯é”é´¨å˜´è£¡ï¼ç”œåˆ°ä»–ç‰™é½’ç—›ï¼' },
        { id: 24, name: 'ğŸ¦· è›€ç‰™æ”»æ“Š', icon: 'ğŸ˜·', msg: 'ä½ å°è‘—å¯é”é´¨å“ˆæ°£ï¼Œå‚³æŸ“äº†è›€ç‰™èŒï¼ä»–çš„ç‰™é½’é–‹å§‹ç—›äº†ï¼' },
        { id: 25, name: 'ğŸ’¯ 100å¼µæ•¸å­¸è€ƒå·', icon: 'ğŸ“œ', msg: 'ä½ ä¸Ÿå‡º100å¼µæ•¸å­¸è€ƒå·ï¼å¯é”é´¨çœ‹åˆ°å¯†å¯†éº»éº»çš„æ•¸å­—ç›´æ¥æšˆå€’ï¼' },
        { id: 26, name: 'ğŸ”§ æ‹”ç‰™æ”»æ“Š', icon: 'ğŸ”§', msg: 'ä½ æ‹¿å‡ºä¸€æŠŠå¤§æ¿æ‰‹è¦å¹«å¯é”é´¨æ‹”ç‰™ï¼ä»–åš‡å¾—è‡‰è‰²ç™¼ç™½ï¼' },
        { id: 27, name: 'ğŸ¹ é¦™æ¸¯è…³å¼“ç®­', icon: 'ğŸ¦¶', msg: 'ä½ æŠŠè‡­è¥ªå­ç¶åœ¨ç®­ä¸Šå°„å‡ºå»ï¼ç²¾æº–å‘½ä¸­ç´…å¿ƒï¼è‡­æ°£æ²–å¤©ï¼' },
        { id: 28, name: 'ğŸ¥” æ„›æƒ…æ´‹èŠ‹ç‰‡', icon: 'ğŸ§¡', msg: 'ä½ ä¸Ÿå‡ºä¸€ç‰‡æ„›å¿ƒå½¢ç‹€çš„æ´‹èŠ‹ç‰‡ï¼å¯é”é´¨åƒäº†è¦ºå¾—å¿ƒè£¡æš–æš–çš„...ç„¶å¾Œå°±è‚šå­ç—›äº†ï¼' }
    ];

    // --- å¯é”é´¨çš„åæ“Š (æ“´å……åˆ°20å€‹æç¬‘æ‹›å¼) ---
    const ENEMY_ATTACKS = [
        { name: 'é ­ç—›å…‰æ³¢', icon: 'âš¡', msg: 'å¯é”é´¨é ­ç—›äº†ï¼ç™¼å°„å‡ºå¥‡æ€ªçš„å…‰æ³¢ï¼' },
        { name: 'ç™¼å‘†å‡è¦–', icon: 'ğŸ‘€', msg: 'å¯é”é´¨ä¸€ç›´ç›¯è‘—ä½ çœ‹... ä½ è¦ºå¾—å¿ƒè£¡ç™¼æ¯›ï¼' },
        { name: 'æ»‘å€’æ’æ“Š', icon: 'ğŸ’«', msg: 'å¯é”é´¨ä¸å°å¿ƒæ»‘å€’ï¼Œæ•´å€‹äººæ’åœ¨ä½ èº«ä¸Šï¼' },
        { name: 'å™´æ°´æ”»æ“Š', icon: 'ğŸ’§', msg: 'å¯é”é´¨å™´äº†ä¸€å£æ°´åœ¨ä½ è‡‰ä¸Šï¼å¥½æ¿•å•Šï¼' },
        { name: 'å‘±å‘±å™ªéŸ³', icon: 'ğŸ¦†', msg: 'å¯é”é´¨å¤§å«ã€Œå‘±å‘±å‘±ã€ï¼åµæ­»äººäº†ï¼' },
        { name: 'æ”é ­å›°æƒ‘', icon: 'â“', msg: 'å¯é”é´¨æ­ªè‘—é ­... ä»–è‡ªå·±ä¹Ÿæä¸æ¸…æ¥šç‹€æ³ï¼Œä½†ä½ å—å‚·äº†ï¼' },
        { name: 'é ­ç—›çˆ†ç‚¸', icon: 'ğŸ’¥', msg: 'å¯é”é´¨é ­ç—›åˆ°çˆ†ç‚¸ï¼ç¢ç‰‡é£›å¾—åˆ°è™•éƒ½æ˜¯ï¼' },
        { name: 'è¿·ç³Šäº‚èˆ', icon: 'ğŸŒ€', msg: 'å¯é”é´¨é–‹å§‹è½‰åœˆåœˆï¼è½‰åˆ°é ­æšˆæ’åˆ°ä½ ï¼' },
        { name: 'æ‰“å—æ”»æ“Š', icon: 'ğŸ¤¢', msg: 'å¯é”é´¨æ‰“äº†ä¸€å€‹è¶…å¤§çš„å—ï¼è‡­æ°£ç†å¤©ï¼' },
        { name: 'è£æ­»é¨™äºº', icon: 'ğŸ’€', msg: 'å¯é”é´¨çªç„¶è£æ­»ï¼ä½ åš‡äº†ä¸€è·³ï¼Œçµæœä»–è¶æ©Ÿå·è¥²ï¼' },
        { name: 'é ­æ’åœ°æ¿', icon: 'ğŸ”¨', msg: 'å¯é”é´¨ç”¨é ­æ’åœ°æ¿ï¼åœ°æ¿è£‚é–‹äº†ï¼Œä½ æ‰é€²æ´è£¡ï¼' },
        { name: 'æµå£æ°´æ”»æ“Š', icon: 'ğŸ¤¤', msg: 'å¯é”é´¨æµäº†ä¸€å¤§å †å£æ°´ï¼é»é»çš„ï¼Œå¥½å™å¿ƒï¼' },
        { name: 'æ‰“çŒç¡', icon: 'ğŸ˜´', msg: 'å¯é”é´¨é–‹å§‹æ‰“çŒç¡... çªç„¶å¤¢éŠæ”»æ“Šä½ ï¼' },
        { name: 'ç¿»ç™½çœ¼', icon: 'ğŸ™„', msg: 'å¯é”é´¨ç¿»äº†ä¸€å€‹è¶…å¤§çš„ç™½çœ¼ï¼ä½ è¢«ç™½çœ¼æ”»æ“Šäº†ï¼' },
        { name: 'é ­ç—›è·³èº', icon: 'ğŸ¦˜', msg: 'å¯é”é´¨é ­ç—›åˆ°é–‹å§‹äº‚è·³ï¼ä¸å°å¿ƒè·³åˆ°ä½ çš„é ­ä¸Šï¼' },
        { name: 'è¿·ç³Šå™´åš', icon: 'ğŸ¤§', msg: 'å¯é”é´¨æ‰“äº†ä¸€å€‹è¶…å¤§çš„å™´åšï¼é¼»æ¶•é£›åˆ°ä½ è‡‰ä¸Šï¼' },
        { name: 'é ­ç—›æ–æ“º', icon: 'ğŸª', msg: 'å¯é”é´¨é ­ç—›åˆ°é–‹å§‹æ–æ“ºï¼åƒå€‹ä¸å€’ç¿ä¸€æ¨£æ’ä½ ï¼' },
        { name: 'è£å¯æ„›', icon: 'ğŸ¥º', msg: 'å¯é”é´¨çªç„¶è£å¯æ„›ï¼ä½ è¢«èŒåˆ°å¿˜è¨˜é˜²ç¦¦ï¼' },
        { name: 'é ­ç—›æ—‹é¢¨', icon: 'ğŸŒªï¸', msg: 'å¯é”é´¨é ­ç—›åˆ°é–‹å§‹è½‰åœˆï¼å½¢æˆä¸€å€‹å°æ—‹é¢¨æŠŠä½ æ²é€²å»ï¼' },
        { name: 'è¿·ç³Šè¡æ’', icon: 'ğŸ‚', msg: 'å¯é”é´¨æä¸æ¸…æ¥šæ–¹å‘ï¼Œåˆ°è™•äº‚è¡ï¼æœ€å¾Œæ’åˆ°ä½ ï¼' }
    ];

    let myChar = '';
    let myHp = 100;
    let enemyHp = 100;
    let curHour = 0;
    let curMin = 0;
    let forcedMistakeType = null;
    let countdownTimer = null;
    let timeLeft = 30;
    let comboCount = 0;
    let startTime = null;

    const canvas = document.getElementById('clockCanvas');
    const ctx = canvas.getContext('2d');
    const radius = canvas.height / 2;

    // --- åˆå§‹åŒ– (æ–°å¢è§’è‰²åˆ¤æ–·) ---
    function initGame(char) {
        myChar = char;
        const pImg = document.getElementById('char-player-img');
        const bgEl = document.getElementById('game-container');
        
        pImg.src = IMGS[char];
        // è¨­å®šä¸åŒè§’è‰²çš„èƒŒæ™¯å’Œå…‰ç’°
        if(char === 'snorlax') {
            pImg.classList.add('aura-snorlax'); bgEl.style.background = '#E3F2FD'; 
        } else if(char === 'mew') {
            pImg.classList.add('aura-mew'); bgEl.style.background = '#FCE4EC';
        } else if(char === 'pikachu') {
            pImg.classList.add('aura-pikachu'); bgEl.style.background = '#FFFACD';
        } else if(char === 'eevee') {
            pImg.classList.add('aura-eevee'); bgEl.style.background = '#FAF0E6';
        } else if(char === 'alcremie') {
            pImg.classList.add('aura-alcremie'); bgEl.style.background = '#FFF0F5';
        } else if(char === 'terapagos') {
            pImg.classList.add('aura-terapagos'); bgEl.style.background = '#E0F7FA';
        } else if(char === 'charizard') {
            pImg.classList.add('aura-charizard'); bgEl.style.background = '#FFF3E0';
        } else if(char === 'jirachi') {
            pImg.classList.add('aura-jirachi'); bgEl.style.background = '#FFF9C4';
        } else if(char === 'riolu') {
            pImg.classList.add('aura-riolu'); bgEl.style.background = '#E3F2FD';
        }

        document.getElementById('scene-select').classList.add('hidden');
        document.getElementById('scene-game').classList.remove('hidden');
        comboCount = 0;
        updateComboDisplay();
        generateQuestion();
    }

    // --- æ”»æ“Šèˆ‡å‹•ç•«ç³»çµ± ---
    function generateAttacks() {
        let shuffled = [...ATTACK_POOL].sort(() => 0.5 - Math.random());
        let selected = shuffled.slice(0, 4);
        
        const grid = document.getElementById('attack-grid');
        grid.innerHTML = ''; 
        selected.forEach(atk => {
            let btn = document.createElement('button');
            btn.className = 'skill-btn';
            btn.innerHTML = `${atk.icon} ${atk.name}`;
            btn.onclick = () => performAttack(atk);
            grid.appendChild(btn);
        });
        document.getElementById('input-controls').style.display = 'none';
        grid.style.display = 'grid';
        document.getElementById('battle-log').innerHTML = "<span style='color:green'>âœ… ç­”å°äº†ï¼å¿«é¸ä¸€å€‹è¶…å¥½ç¬‘çš„æ‹›å¼ï¼</span>";
    }

    function performAttack(atk) {
        const grid = document.getElementById('attack-grid');
        grid.style.display = 'none';
        document.getElementById('battle-log').innerText = atk.msg;
        const player = document.getElementById('char-player-img');
        const enemy = document.getElementById('char-enemy-img');
        const projectile = document.getElementById('player-projectile');
        const dmgPopup = document.getElementById('damage-popup');
        const battleScene = document.querySelector('.battle-scene');
        const gameContainer = document.getElementById('game-container');

        // ç¬¬ä¸€éšæ®µï¼šé å‚™å‹•ä½œ
        player.classList.add('anim-ready');
        setTimeout(() => {
            player.classList.remove('anim-ready');
            player.classList.add('anim-jump');
            
            // ç¬¬äºŒéšæ®µï¼šè¡åˆºæ”»æ“Š
            setTimeout(() => {
                player.classList.remove('anim-jump');
                player.classList.add('anim-lunge-right');
                projectile.innerText = atk.icon;
                setTimeout(() => projectile.classList.add('anim-shoot'), 100);
            }, 200);
        }, 300);

        // ç¬¬ä¸‰éšæ®µï¼šæ“Šä¸­æ•ˆæœ
        setTimeout(() => {
            // èƒŒæ™¯éœ‡å‹•
            battleScene.classList.add('shake');
            setTimeout(() => battleScene.classList.remove('shake'), 500);
            
            // é–ƒå…‰æ•ˆæœ
            const flash = document.createElement('div');
            flash.className = 'flash-effect';
            gameContainer.appendChild(flash);
            setTimeout(() => flash.remove(), 300);
            
            // è¡æ“Šæ³¢
            const shockwave = document.createElement('div');
            shockwave.className = 'shockwave';
            shockwave.style.left = '75%';
            battleScene.appendChild(shockwave);
            setTimeout(() => shockwave.remove(), 600);
            
            // ç²’å­æ•ˆæœ
            for(let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.textContent = ['âœ¨', 'â­', 'ğŸ’«', 'ğŸŒŸ', 'âš¡'][Math.floor(Math.random() * 5)];
                    particle.style.left = '75%';
                    particle.style.top = '45%';
                    const angle = (Math.PI * 2 * i) / 5;
                    const distance = 50 + Math.random() * 30;
                    particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
                    particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
                    battleScene.appendChild(particle);
                    setTimeout(() => particle.remove(), 1000);
                }, i * 50);
            }
            
            enemy.classList.add('anim-hit'); 
            enemy.classList.add('anim-knockback');
            enemy.classList.add('filter-hurt');
            
            // è¨ˆç®—å‚·å®³ï¼ˆé€£æ“ŠåŠ æˆï¼‰
            let baseDmg = 20 + Math.floor(Math.random()*10);
            let comboBonus = Math.floor(comboCount / 2) * 5;
            let totalDmg = baseDmg + comboBonus;
            
            dmgPopup.innerText = "-" + totalDmg; 
            if (comboBonus > 0) {
                dmgPopup.innerText += ` (é€£æ“Š+${comboBonus})`;
            }
            dmgPopup.style.display = 'block';
            
            // çˆ†ç‚¸ç‰¹æ•ˆ
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.textContent = 'ğŸ’¥';
            explosion.style.left = '75%';
            battleScene.appendChild(explosion);
            setTimeout(() => explosion.remove(), 800);
            
            enemyHp -= totalDmg; 
            updateHp();
            
            setTimeout(() => {
                player.classList.remove('anim-lunge-right'); 
                projectile.classList.remove('anim-shoot');
                enemy.classList.remove('anim-hit'); 
                enemy.classList.remove('anim-knockback');
                enemy.classList.remove('filter-hurt');
                dmgPopup.style.display = 'none';
                if(enemyHp <= 0) {
                    setTimeout(() => endGame(true), 800);
                } else {
                    document.getElementById('next-btn').style.display = 'block';
                    let msg = "å¯é”é´¨è¢«æ‰“æšˆäº†ï¼è¶å‹è¿½æ“Šï¼";
                    if (comboCount >= 3) {
                        msg += ` ğŸ”¥ ${comboCount}é€£æ“Šï¼å¤ªå²å®³äº†ï¼`;
                    }
                    document.getElementById('battle-log').innerText = msg;
                }
            }, 1000);
        }, 600);
    }

    function enemyAttack() {
        const atk = ENEMY_ATTACKS[Math.floor(Math.random() * ENEMY_ATTACKS.length)];
        document.getElementById('battle-log').innerHTML = `<span style='color:#d32f2f'>${atk.msg}</span>`;
        const enemy = document.getElementById('char-enemy-img');
        const player = document.getElementById('char-player-img');
        const proj = document.getElementById('enemy-projectile');
        const battleScene = document.querySelector('.battle-scene');
        const gameContainer = document.getElementById('game-container');

        // é å‚™å‹•ä½œ
        enemy.classList.add('anim-ready');
        setTimeout(() => {
            enemy.classList.remove('anim-ready');
            enemy.classList.add('anim-jump');
            
            setTimeout(() => {
                enemy.classList.remove('anim-jump');
                enemy.classList.add('anim-lunge-left');
                proj.innerText = atk.icon;
                setTimeout(() => proj.classList.add('anim-shoot-left'), 100);
            }, 200);
        }, 300);

        setTimeout(() => {
            // èƒŒæ™¯éœ‡å‹•
            battleScene.classList.add('shake');
            setTimeout(() => battleScene.classList.remove('shake'), 500);
            
            // é–ƒå…‰æ•ˆæœï¼ˆè¼ƒå¼±ï¼‰
            const flash = document.createElement('div');
            flash.className = 'flash-effect';
            flash.style.background = 'rgba(255, 0, 0, 0.3)';
            gameContainer.appendChild(flash);
            setTimeout(() => flash.remove(), 300);
            
            // è¡æ“Šæ³¢
            const shockwave = document.createElement('div');
            shockwave.className = 'shockwave';
            shockwave.style.left = '25%';
            shockwave.style.borderColor = 'rgba(255, 0, 0, 0.6)';
            battleScene.appendChild(shockwave);
            setTimeout(() => shockwave.remove(), 600);
            
            player.classList.add('anim-hit'); 
            player.classList.add('anim-knockback');
            player.classList.add('filter-hurt');
            
            myHp -= 20; 
            updateHp();
            
            setTimeout(() => {
                enemy.classList.remove('anim-lunge-left'); 
                proj.classList.remove('anim-shoot-left');
                player.classList.remove('anim-hit'); 
                player.classList.remove('anim-knockback');
                player.classList.remove('filter-hurt');
                if(myHp <= 0) setTimeout(() => endGame(false), 1000);
            }, 500);
        }, 600);
    }

    // --- æ™‚é˜é‚è¼¯ ---
    function generateQuestion() {
        // é‡ç½®å€’æ•¸è¨ˆæ™‚
        if (countdownTimer) clearInterval(countdownTimer);
        timeLeft = 30;
        startTime = Date.now();
        updateCountdown();
        startCountdown();
        
        if (forcedMistakeType === 'tricky_hour') {
            curHour = Math.floor(Math.random() * 12) + 1;
            curMin = 40 + Math.floor(Math.random() * 20); 
            document.getElementById('battle-log').innerHTML = "<span style='color:red'>ğŸ”¥ ç‰¹è¨“ï¼šçŸ­é‡å¿«ç¢°åˆ°ä¸‹å€‹æ•¸å­—äº†ï¼Œè¦å°å¿ƒï¼</span>";
        } else if (forcedMistakeType === 'minutes') {
            curHour = Math.floor(Math.random() * 12) + 1;
            curMin = Math.floor(Math.random() * 60);
            document.getElementById('battle-log').innerHTML = "<span style='color:red'>ğŸ”¥ ç‰¹è¨“ï¼šä»”ç´°æ•¸ä¸€æ•¸å°æ ¼å­ï¼</span>";
        } else {
            curHour = Math.floor(Math.random() * 12) + 1;
            if(Math.random() > 0.3) curMin = Math.floor(Math.random() * 12) * 5;
            else curMin = Math.floor(Math.random() * 60);
            document.getElementById('battle-log').innerText = "è«‹è¼¸å…¥ï¼šç¾åœ¨æ˜¯å¹¾é»å¹¾åˆ†ï¼Ÿ";
            document.getElementById('battle-log').style.color = "#333";
        }
        drawClock(curHour, curMin);
    }
    
    // å€’æ•¸è¨ˆæ™‚åŠŸèƒ½
    function startCountdown() {
        countdownTimer = setInterval(() => {
            timeLeft--;
            updateCountdown();
            if (timeLeft <= 0) {
                clearInterval(countdownTimer);
                timeUp();
            }
        }, 1000);
    }
    
    function updateCountdown() {
        const timerEl = document.getElementById('countdown-timer');
        timerEl.textContent = timeLeft;
        if (timeLeft <= 10) {
            timerEl.classList.add('countdown-warning');
        } else {
            timerEl.classList.remove('countdown-warning');
        }
    }
    
    function timeUp() {
        clearInterval(countdownTimer);
        document.getElementById('battle-log').innerHTML = "<span style='color:red'>â° æ™‚é–“åˆ°äº†ï¼å¯é”é´¨è¶æ©Ÿæ”»æ“Šï¼</span>";
        enemyAttack();
        comboCount = 0;
        updateComboDisplay();
        setTimeout(() => {
            document.getElementById('input-controls').style.display = 'block';
            document.getElementById('in-hour').value = '';
            document.getElementById('in-min').value = '';
            generateQuestion();
        }, 2000);
    }
    
    // é€£æ“Šç³»çµ±
    function updateComboDisplay() {
        const comboEl = document.getElementById('combo-counter');
        const countEl = document.getElementById('combo-count');
        countEl.textContent = comboCount;
        if (comboCount >= 2) {
            comboEl.classList.add('combo-active');
        } else {
            comboEl.classList.remove('combo-active');
        }
    }
    
    // æ™‚é–“çå‹µé¡¯ç¤º
    function showTimeBonus(secondsLeft) {
        const bonusEl = document.getElementById('time-bonus');
        const bonus = Math.floor(secondsLeft / 5);
        if (bonus > 0) {
            bonusEl.textContent = `âš¡ å¿«é€Ÿç­”å°ï¼+${bonus}åˆ†çå‹µï¼`;
            bonusEl.style.display = 'block';
            setTimeout(() => {
                bonusEl.style.display = 'none';
            }, 1000);
        }
    }

    function drawClock(h, m) {
        ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.save(); ctx.translate(radius, radius);
        // éŒ¶ç›¤
        ctx.beginPath(); ctx.arc(0, 0, radius * 0.95, 0, 2*Math.PI); ctx.fillStyle = 'white'; ctx.fill();
        ctx.lineWidth = 8;
        // æ ¹æ“šè§’è‰²æ”¹è®ŠéŒ¶ç›¤é¡è‰²
        let strokeColor = '#4682B4'; // é è¨­å¡æ¯”ç¸è—
        if(myChar === 'mew') strokeColor = '#FF69B4';
        else if(myChar === 'pikachu') strokeColor = '#FFD700';
        else if(myChar === 'eevee') strokeColor = '#A0522D';
        else if(myChar === 'alcremie') strokeColor = '#FFB6C1';
        else if(myChar === 'terapagos') strokeColor = '#87CEEB';
        else if(myChar === 'charizard') strokeColor = '#FF6B35';
        else if(myChar === 'jirachi') strokeColor = '#FFD700';
        else if(myChar === 'riolu') strokeColor = '#4A90E2';
        ctx.strokeStyle = strokeColor; ctx.stroke();

        // åˆ»åº¦
        for(let i=0; i<60; i++) {
            let ang = i * Math.PI / 30; let isMajor = (i % 5 === 0);
            ctx.beginPath();
            if (isMajor) {
                ctx.lineWidth = 4; ctx.strokeStyle = "#333";
                ctx.moveTo(radius*0.80 * Math.sin(ang), -radius*0.80 * Math.cos(ang));
                ctx.lineTo(radius*0.92 * Math.sin(ang), -radius*0.92 * Math.cos(ang));
            } else {
                ctx.lineWidth = 1.5; ctx.strokeStyle = "#999";
                ctx.moveTo(radius*0.85 * Math.sin(ang), -radius*0.85 * Math.cos(ang));
                ctx.lineTo(radius*0.92 * Math.sin(ang), -radius*0.92 * Math.cos(ang));
            }
            ctx.stroke();
        }
        // æ•¸å­—
        ctx.font = "bold " + (radius*0.15) + "px Arial"; ctx.textBaseline="middle"; ctx.textAlign="center"; ctx.fillStyle = '#333';
        for(let num = 1; num <= 12; num++){
            let ang = num * Math.PI / 6;
            ctx.fillText(num.toString(), radius*0.68 * Math.sin(ang), -radius*0.68 * Math.cos(ang));
        }
        // æŒ‡é‡
        let mAng = (m * Math.PI / 30); let hAng = (h % 12 * Math.PI / 6) + (mAng / 12);
        ctx.beginPath(); ctx.lineWidth = 9; ctx.lineCap = "round"; ctx.strokeStyle = '#333'; // æ™‚é‡
        ctx.moveTo(0,0); ctx.rotate(hAng); ctx.lineTo(0, -radius*0.45); ctx.stroke(); ctx.rotate(-hAng);
        ctx.beginPath(); ctx.lineWidth = 5; ctx.lineCap = "round"; ctx.strokeStyle = '#d32f2f'; // åˆ†é‡
        ctx.moveTo(0,0); ctx.rotate(mAng); ctx.lineTo(0, -radius*0.70); ctx.stroke(); ctx.rotate(-mAng);
        ctx.beginPath(); ctx.arc(0, 0, 8, 0, 2*Math.PI); ctx.fillStyle = '#333'; ctx.fill(); // ä¸­å¿ƒ
        ctx.beginPath(); ctx.arc(0, 0, 4, 0, 2*Math.PI); ctx.fillStyle = '#d32f2f'; ctx.fill();
        ctx.restore();
    }

    function checkAnswer() {
        const inH = parseInt(document.getElementById('in-hour').value);
        const inM = parseInt(document.getElementById('in-min').value);
        if(isNaN(inH) || isNaN(inM)) return;
        
        // åœæ­¢å€’æ•¸è¨ˆæ™‚
        if (countdownTimer) {
            clearInterval(countdownTimer);
            const elapsed = (Date.now() - startTime) / 1000;
            const secondsLeft = timeLeft;
            showTimeBonus(secondsLeft);
        }
        
        if(inH === curHour && inM === curMin) {
            // ç­”å°äº†ï¼å¢åŠ é€£æ“Š
            comboCount++;
            updateComboDisplay();
            generateAttacks(); 
            forcedMistakeType = null;
        } else {
            // ç­”éŒ¯äº†ï¼Œé‡ç½®é€£æ“Š
            comboCount = 0;
            updateComboDisplay();
            analyzeError(inH, inM);
        }
    }

    function analyzeError(userH, userM) {
        let html = "";
        let isTrickyHour = (curMin >= 40); 
        if (isTrickyHour && userH === (curHour % 12) + 1) {
            html += `<p>ä½ æŠŠæ™‚é‡çœ‹æˆ <span class="highlight-red">${userH}</span> äº†å—ï¼Ÿ</p>`;
            html += `<p>âš ï¸ é›–ç„¶å¾ˆåƒï¼Œä½†é•·é‡é‚„æ²’èµ°åˆ°12ï¼Œæ‰€ä»¥ç¾åœ¨é‚„æ˜¯ <span class="highlight-blue">${curHour} é»å¤š</span>å–”ï¼</p>`;
            forcedMistakeType = 'tricky_hour';
        } else if (userM !== curMin) {
            let nearestBig = Math.floor(curMin / 5);
            html += `<p>åˆ†é‡æ•¸éŒ¯å›‰ã€‚å…ˆçœ‹ç¶“éçš„å¤§æ•¸å­— <b>${nearestBig}</b>ã€‚</p>`;
            html += `<p>${nearestBig} x 5 = ${nearestBig*5}ï¼Œç„¶å¾Œå†æ•¸å°æ ¼å­ï¼š${nearestBig*5+1}... åˆ° <span class="highlight-blue">${curMin}</span>ï¼</p>`;
            forcedMistakeType = 'minutes';
        } else {
            html += `<p>æ­£ç¢ºç­”æ¡ˆæ˜¯ <span class="highlight-blue">${curHour} é» ${curMin} åˆ†</span>ã€‚</p>`;
            html += `<p>å†ä»”ç´°çœ‹ä¸€ä¸‹å–”ï¼</p>`;
            forcedMistakeType = null;
        }
        document.getElementById('tutorial-text').innerHTML = html;
        document.getElementById('tutorial-overlay').style.display = 'block';
        // é‡ç½®é€£æ“Š
        comboCount = 0;
        updateComboDisplay();
        enemyAttack();
    }

    function closeTutorial() {
        document.getElementById('tutorial-overlay').style.display = 'none';
        document.getElementById('in-hour').value = ''; document.getElementById('in-min').value = '';
        document.getElementById('in-hour').focus(); document.getElementById('battle-log').innerText = "å†è©¦ä¸€æ¬¡ï¼";
    }

    function nextRound() {
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('input-controls').style.display = 'block';
        document.getElementById('in-hour').value = ''; document.getElementById('in-min').value = '';
        // ä¿æŒé€£æ“Šï¼Œä¸é‡ç½®
        generateQuestion();
    }

    function updateHp() {
        document.getElementById('hp-player').style.width = Math.max(0, myHp) + '%';
        document.getElementById('hp-enemy').style.width = Math.max(0, enemyHp) + '%';
    }

    function endGame(win) {
        if (countdownTimer) clearInterval(countdownTimer);
        document.getElementById('scene-game').classList.add('hidden');
        document.getElementById('end-screen').style.display = 'block';
        const img = document.getElementById('end-img');
        if(win) {
            document.getElementById('end-title').innerText = "ğŸ‰ æŒ‘æˆ°æˆåŠŸï¼";
            img.src = IMGS.win; 
            let desc = "ä½ å¤ªå²å®³äº†ï¼å¯é”é´¨å®Œå…¨è¢«æ‰“æ•—äº†ï¼";
            if (comboCount >= 5) {
                desc += `\nğŸ”¥ æœ€é«˜é€£æ“Šï¼š${comboCount}æ¬¡ï¼ä½ æ˜¯æ™‚é˜å¤§å¸«ï¼`;
            }
            document.getElementById('end-desc').innerText = desc;
        } else {
            document.getElementById('end-title').innerText = "ğŸ˜¢ æŒ‘æˆ°å¤±æ•—...";
            img.src = IMGS.lose;
            document.getElementById('end-desc').innerText = "æ²’é—œä¿‚ï¼Œå¤šç·´ç¿’å¹¾æ¬¡ï¼Œä¸‹æ¬¡ä¸€å®šæœƒè´ï¼";
        }
    }
</script>
</body>
</html>