<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¯¶å¯å¤¢æ™‚é˜å¤§äº‚é¬¥ï¼šå…¨å“¡å‡ºæ“Šç‰ˆ</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background-color: #f0f8ff;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            overflow-x: hidden;
            user-select: none;
        }

        /* éŠæˆ²ä¸»å®¹å™¨ */
        #game-container {
            background: white;
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 95%;
            max-width: 500px;
            text-align: center;
            position: relative;
            transition: background 0.5s;
        }

        /* --- é¸è§’ç•«é¢èª¿æ•´ (æ”¹ç‚º 2x2 ç¶²æ ¼) --- */
        .char-select-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        .char-btn {
            padding: 10px; border: 4px solid #ddd; border-radius: 20px; 
            background: white; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center;
            width: auto; /* è‡ªå‹•å¯¬åº¦ */
        }
        .char-btn img { width: 70px; height: 70px; object-fit: contain; }
        .char-btn b { font-size: 1.1rem; margin-top: 5px; }
        .char-btn:active { transform: scale(0.95); }

        /* è§’è‰²ä¸»é¡Œè‰² */
        .theme-snorlax { border-color: #4682B4; background: #E3F2FD; color: #0D47A1; }
        .theme-mew { border-color: #FF69B4; background: #FCE4EC; color: #C2185B; }
        .theme-pikachu { border-color: #FFD700; background: #FFFACD; color: #9A8C00; }
        .theme-eevee { border-color: #A0522D; background: #FAF0E6; color: #8B4513; }


        /* --- æˆ°é¬¥å ´æ™¯ --- */
        .battle-scene {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: 180px;
            padding: 0 5px;
            margin-bottom: 10px;
            position: relative;
        }

        .character-wrapper {
            position: relative;
            width: 130px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }

        .poke-img {
            width: 110px; height: 110px; object-fit: contain; z-index: 2; transition: transform 0.1s;
        }

        .player-flip { transform: scaleX(-1); }

        /* è¡€æ¢ */
        .hp-bar-frame {
            width: 100%; height: 14px; background: #333; border-radius: 7px;
            border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            overflow: hidden; margin-bottom: 5px; position: relative; z-index: 5;
        }
        .hp-fill {
            height: 100%; background: linear-gradient(90deg, #4caf50, #8bc34a);
            width: 100%; transition: width 0.4s ease-out;
        }
        .hp-text {
            font-size: 0.9rem; font-weight: bold; color: #555; margin-bottom: 2px;
        }

        /* å…‰ç’°èˆ‡ç‰¹æ•ˆ */
        .aura-snorlax { filter: drop-shadow(0 0 8px #2196F3); }
        .aura-mew { filter: drop-shadow(0 0 8px #E91E63); }
        .aura-pikachu { filter: drop-shadow(0 0 8px #FFD700); }
        .aura-eevee { filter: drop-shadow(0 0 8px #A0522D); }
        .aura-psyduck { filter: drop-shadow(0 0 8px #FFC107); }
        .filter-hurt { filter: sepia(1) hue-rotate(-50deg) saturate(5) brightness(0.8); }

        /* --- å‹•ç•« Class --- */
        .anim-lunge-right { animation: lungeRight 0.3s ease-in-out; }
        @keyframes lungeRight {
            0% { transform: scaleX(-1) translateX(0); }
            50% { transform: scaleX(-1) translateX(-40px); }
            100% { transform: scaleX(-1) translateX(0); }
        }
        .anim-lunge-left { animation: lungeLeft 0.3s ease-in-out; }
        @keyframes lungeLeft {
            0% { transform: translateX(0); }
            50% { transform: translateX(-40px); }
            100% { transform: translateX(0); }
        }
        .anim-hit { animation: hitShake 0.4s ease-in-out; }
        @keyframes hitShake {
            0% { transform: translate(0, 0) rotate(0); }
            20% { transform: translate(-5px, 5px) rotate(-5deg); }
            40% { transform: translate(5px, -5px) rotate(5deg); }
            60% { transform: translate(-5px, 0px) rotate(-5deg); }
            80% { transform: translate(5px, 0px) rotate(5deg); }
            100% { transform: translate(0, 0) rotate(0); }
        }
        .projectile {
            position: absolute; font-size: 3rem; top: 45%; left: 25%;
            pointer-events: none; z-index: 10; opacity: 0;
        }
        .anim-shoot { animation: shootObj 0.6s forwards; }
        @keyframes shootObj {
            0% { left: 25%; opacity: 1; transform: scale(0.5); }
            80% { left: 75%; opacity: 1; transform: scale(1.2) rotate(360deg); }
            100% { left: 85%; opacity: 0; transform: scale(1.5); }
        }
        .projectile-enemy {
            position: absolute; font-size: 3rem; top: 45%; right: 25%;
            pointer-events: none; z-index: 10; opacity: 0;
        }
        .anim-shoot-left { animation: shootObjLeft 0.6s forwards; }
        @keyframes shootObjLeft {
            0% { right: 25%; opacity: 1; transform: scale(0.5); }
            80% { right: 75%; opacity: 1; transform: scale(1.2) rotate(-360deg); }
            100% { right: 85%; opacity: 0; transform: scale(1.5); }
        }
        .damage-text {
            position: absolute; color: #d32f2f; font-weight: 900; font-size: 2.5rem;
            text-shadow: 2px 2px 0 #fff, 0 0 5px rgba(0,0,0,0.3);
            pointer-events: none; animation: floatUp 1s forwards; z-index: 20;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.2); }
        }

        /* --- UI --- */
        canvas {
            background: #fff; border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 10px auto; display: block;
            width: 260px; height: 260px;
        }
        .input-area {
            background: rgba(255,255,255,0.85); border: 2px solid #ddd;
            padding: 15px; border-radius: 15px;
        }
        input[type="number"] {
            width: 65px; height: 55px; font-size: 2rem; text-align: center;
            border: 3px solid #555; border-radius: 10px; margin: 0 5px;
            background: #fff; color: #333; font-weight: bold;
        }
        .attack-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            margin-top: 10px; display: none;
        }
        .skill-btn {
            background: #ff5722; color: white; border: 2px solid #bf360c;
            padding: 15px 5px; border-radius: 12px; font-size: 1.1rem; 
            font-weight: 900; cursor: pointer; box-shadow: 0 4px 0 #bf360c;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8); transition: transform 0.1s;
            line-height: 1.3; white-space: normal;
        }
        .skill-btn:active { transform: translateY(4px); box-shadow: none; }
        .skill-btn:nth-child(odd) { background: #009688; border-color: #004d40; box-shadow: 0 4px 0 #004d40; }
        .skill-btn:nth-child(even) { background: #673ab7; border-color: #311b92; box-shadow: 0 4px 0 #311b92; }

        #tutorial-overlay, #end-screen {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 50; border-radius: 20px;
            padding: 20px; box-sizing: border-box;
        }
        .tutorial-content { text-align: left; font-size: 1.1rem; line-height: 1.6; color: #333; }
        .highlight-red { color: #d32f2f; font-weight: bold; }
        .highlight-blue { color: #1976d2; font-weight: bold; }

        .btn-main {
            background: #2196f3; color: white; border: none; padding: 15px 30px;
            border-radius: 50px; font-size: 1.3rem; font-weight: bold;
            cursor: pointer; margin-top: 20px; box-shadow: 0 4px 0 #1565c0; width: 100%;
        }
        .btn-main:active { transform: translateY(4px); box-shadow: none; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="game-container">

    <div id="scene-select">
        <h1>ğŸ”¥ å¯¶å¯å¤¢æ™‚é˜å¤§äº‚é¬¥ ğŸ”¥</h1>
        <p>é¸æ“‡ä½ çš„æˆ°å£«ï¼š</p>
        <div class="char-select-grid">
            <button class="char-btn theme-snorlax" onclick="initGame('snorlax')">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/143.gif" alt="å¡æ¯”ç¸">
                <b>å¡æ¯”ç¸</b>
            </button>
            <button class="char-btn theme-mew" onclick="initGame('mew')">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/151.gif" alt="å¤¢å¹»">
                <b>å¤¢å¹»</b>
            </button>
            <button class="char-btn theme-pikachu" onclick="initGame('pikachu')">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/25.gif" alt="çš®å¡ä¸˜">
                <b>çš®å¡ä¸˜</b>
            </button>
            <button class="char-btn theme-eevee" onclick="initGame('eevee')">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/133.gif" alt="ä¼Šå¸ƒ">
                <b>ä¼Šå¸ƒ</b>
            </button>
        </div>
    </div>

    <div id="scene-game" class="hidden">
        
        <div class="battle-scene">
            <div class="character-wrapper">
                <div class="hp-text">ä½ </div>
                <div class="hp-bar-frame"><div id="hp-player" class="hp-fill"></div></div>
                <img id="char-player-img" class="poke-img player-flip" src="" alt="Player">
                <div id="player-projectile" class="projectile">ğŸ’¨</div>
            </div>

            <div style="font-weight:900; font-size:2rem; color:#ddd; padding-bottom:40px;">VS</div>

            <div class="character-wrapper">
                <div class="hp-text">å¯é”é´¨</div>
                <div class="hp-bar-frame"><div id="hp-enemy" class="hp-fill" style="background: linear-gradient(90deg, #ff5252, #d32f2f);"></div></div>
                <img id="char-enemy-img" class="poke-img aura-psyduck" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/54.gif" alt="Psyduck">
                <div id="enemy-projectile" class="projectile-enemy">ğŸ’§</div>
                <div id="damage-popup" class="damage-text" style="display:none; top: 20%; right: 10%;">-25</div>
            </div>
        </div>

        <div id="battle-log" style="min-height:40px; color:#333; font-weight:bold; margin-bottom:5px; background:#fff; padding:5px; border-radius:10px; border:1px solid #ddd;">
            æˆ°é¬¥é–‹å§‹ï¼é¸æ“‡ä½ çš„å¯¶å¯å¤¢ï¼
        </div>

        <div id="quiz-section">
            <canvas id="clockCanvas" width="300" height="300"></canvas>
            
            <div class="input-area">
                <div id="input-controls">
                    <input type="number" id="in-hour" placeholder="æ™‚" min="1" max="12"> :
                    <input type="number" id="in-min" placeholder="åˆ†" min="0" max="59">
                    <br><br>
                    <button onclick="checkAnswer()" class="btn-main" style="margin-top:0;">æ”»æ“Šï¼</button>
                </div>

                <div id="attack-grid" class="attack-grid"></div>
                
                <button id="next-btn" class="btn-main" style="display:none;" onclick="nextRound()">ä¸‹ä¸€é¡Œ</button>
            </div>
        </div>

        <div id="tutorial-overlay">
            <h2 style="color:#d32f2f;">ğŸ¤• å“å‘€ï¼çœ‹éŒ¯äº†ï¼</h2>
            <div id="tutorial-text" class="tutorial-content"></div>
            <button class="btn-main" style="background:#4caf50;" onclick="closeTutorial()">æˆ‘çŸ¥é“äº†ï¼Œå†è©¦ä¸€æ¬¡ï¼</button>
        </div>
    </div>

    <div id="end-screen">
        <h1 id="end-title"></h1>
        <img id="end-img" style="width:150px; height:150px;" src="" alt="Win/Lose">
        <p id="end-desc" style="font-size:1.2rem; font-weight:bold;"></p>
        <button class="btn-main" onclick="location.reload()">å†ä¾†ä¸€å ´</button>
    </div>

</div>

<script>
    // --- åœ–ç‰‡è³‡æº (æ–°å¢çš®å¡ä¸˜èˆ‡ä¼Šå¸ƒ) ---
    const IMGS = {
        snorlax: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/143.gif",
        mew: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/151.gif",
        pikachu: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/25.gif",
        eevee: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/133.gif",
        psyduck: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/showdown/54.gif",
        win: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png",
        lose: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png"
    };

    // --- æ“´å……åˆ° 28 å€‹æç¬‘æ”»æ“Šæ‹›å¼åº« ---
    const ATTACK_POOL = [
        // åŸæœ‰ 20 å€‹
        { id: 1, name: 'ğŸ’¨ é€£ç’°è‡­å±', icon: 'ğŸ’¨', msg: 'ä½ æ”¾äº†ä¸€å€‹è¶…ç´šéŸ¿å±ï¼å¯é”é´¨è¢«è‡­æšˆäº†ï¼' },
        { id: 2, name: 'ğŸ¤£ æ”ç™¢æ”»æ“Š', icon: 'ğŸ‘', msg: 'ä½ å·è¥²å¯é”é´¨çš„èƒ³è‚¢çª©ï¼ä»–ç¬‘åˆ°åœ¨åœ°ä¸Šæ‰“æ»¾ï¼' },
        { id: 3, name: 'ğŸ¤ª æ‰®é¬¼è‡‰', icon: 'ğŸ¤¡', msg: 'ä½ åšäº†ä¸€å€‹è¶…é†œçš„é¬¼è‡‰ï¼å¯é”é´¨åš‡å‘†äº†ï¼' },
        { id: 4, name: 'ğŸ¦µ æ‘³è…³çš®å½ˆå°„', icon: 'ğŸ¥', msg: 'ä½ æŠŠé™³å¹´è…³çš®å½ˆå‡ºå»ï¼ç²¾æº–å‘½ä¸­å¯é”é´¨çš„é¼»å­”ï¼' }, 
        { id: 5, name: 'ğŸ’¤ éœ‡å¤©æ‰“å‘¼', icon: 'ğŸ”Š', msg: 'ä½ çš„æ‰“å‘¼è²åƒæ‰“é›·ä¸€æ¨£ï¼éœ‡ç ´äº†å¯é”é´¨çš„è€³è†œï¼' },
        { id: 6, name: 'ğŸ¦¶ ç„¡æ•µè‡­è…³ä¸«', icon: 'ğŸ¤¢', msg: 'ä½ ä¼¸å‡ºæ²’æ´—çš„è‡­è…³ï¼é€™å‘³é“æ¯”åƒåœ¾è»Šé‚„å¯æ€•ï¼' },
        { id: 7, name: 'ğŸ¦  å·¨å¤§é¼»å±', icon: 'â˜ï¸', msg: 'ä½ æŒ–å‡ºä¸€é¡†ç‰¹å¤§è™Ÿé¼»å±ï¼Œé»åœ¨å¯é”é´¨é ­ä¸Šï¼' },
        { id: 8, name: 'ğŸ‘ å±è‚¡æ’æ“Š', icon: 'ğŸ’¥', msg: 'ä½ ç”¨å±è‚¡ç”¨åŠ›æ’é£›å¯é”é´¨ï¼å¥½æœ‰å½ˆæ€§å•Šï¼' },
        { id: 9, name: 'ğŸ˜­ è€è³´æ‰“æ»¾', icon: 'ğŸ›Œ', msg: 'ä½ èººåœ¨åœ°ä¸Šå¤§å“­æ‰“æ»¾ï¼å¯é”é´¨è¦ºå¾—å¾ˆå°·å°¬...' },
        { id: 10, name: 'ğŸ¤ èƒ–è™æ­Œè²', icon: 'ğŸ¤', msg: 'ä½ é–‹å§‹å”±è¶…é›£è½çš„æ­Œï¼å¯é”é´¨ç—›è‹¦åœ°æ‘€ä½è€³æœµï¼' },
        { id: 11, name: 'ğŸŒ é¦™è•‰çš®é™·é˜±', icon: 'ğŸŒ', msg: 'ä½ ä¸Ÿå‡ºé¦™è•‰çš®ï¼å¯é”é´¨è¸©åˆ°æ»‘äº†ä¸€å¤§è·¤ï¼' },
        { id: 12, name: 'â„ï¸ æ€¥å‡å†·ç¬‘è©±', icon: 'â›„', msg: 'ä½ èªªäº†ä¸€å€‹è¶…å†·çš„ç¬‘è©±ï¼ç©ºæ°£ç¬é–“çµå†°äº†ï¼' },
        { id: 13, name: 'ğŸ‘™ å·ç©¿å…§è¤²', icon: 'ğŸ©²', msg: 'ä½ æŠŠå…§è¤²å¥—åœ¨é ­ä¸Šè¡éå»ï¼å¯é”é´¨è¢«ä½ çš„é€ å‹åš‡å‚»äº†ï¼' },
        { id: 14, name: 'ğŸ’‹ å™å¿ƒé£›å»', icon: 'ğŸ’‹', msg: 'ä½ é€å‡ºå……æ»¿å£æ°´çš„é£›å»ï¼å¯é”é´¨è¦ºå¾—è¶…å™å¿ƒï¼' },
        { id: 15, name: 'ğŸ¤ æè‡‰é °', icon: 'ğŸ¤', msg: 'ä½ ç”¨åŠ›æå¯é”é´¨çš„è‡‰é °ï¼è‡‰éƒ½è¢«æ‹‰é•·äº†ï¼' },
        { id: 16, name: 'ğŸ“– ç„¡èŠæ•…äº‹', icon: 'ğŸ¥±', msg: 'ä½ é–‹å§‹è¬›æ•¸å­¸èª²çš„æ•…äº‹... å¯é”é´¨ç¡è‘—äº†ï¼' },
        { id: 17, name: 'ğŸ’¦ åå£æ°´', icon: 'ğŸ’¦', msg: 'å‘¸ï¼ä½ åäº†ä¸€å£å£æ°´ï¼å¾ˆä¸è¡›ç”Ÿä½†å¾ˆæœ‰æ•ˆï¼' },
        { id: 18, name: 'ğŸ–ï¸ äº‚ç•«è‡‰', icon: 'ğŸ–ï¸', msg: 'ä½ æ‹¿å‡ºå½©è‰²ç­†åœ¨å¯é”é´¨è‡‰ä¸Šç•«äº†ä¸€éš»çƒé¾œï¼' },
        { id: 19, name: 'ğŸ© å·åƒé›¶é£Ÿ', icon: 'ğŸ©', msg: 'ä½ æ¶èµ°å¯é”é´¨çš„é¤…ä¹¾åƒæ‰ï¼ä»–çš„å¿ƒç¢äº†ï¼' },
        { id: 20, name: 'ğŸ‘ƒ é¼»æ¯›æ”»æ“Š', icon: 'ã€°ï¸', msg: 'ä½ æ‹”ä¸‹ä¸€æ ¹é¼»æ¯›ç”©éå»ï¼é€™æ˜¯ä»€éº¼å¥‡æ€ªçš„æ‹›å¼ï¼Ÿï¼' },
        // æ–°å¢ 8 å€‹
        { id: 21, name: 'ğŸ€ çš®çƒæ”»æ“Š', icon: 'ğŸ€', msg: 'ä½ ä¸Ÿå‡ºä¸€é¡†è¶…æœ‰å½ˆæ€§çš„çš®çƒï¼åœ¨å¯é”é´¨è‡‰ä¸Šå½ˆäº†åä¸‹ï¼' },
        { id: 22, name: 'ğŸ˜­ å¤§å“­æ”»æ“Š', icon: 'ğŸŒŠ', msg: 'ä½ å¼µå¤§å˜´å·´å“‡å“‡å¤§å“­ï¼çœ¼æ·šåƒå™´æ³‰ä¸€æ¨£å™´å‘å¯é”é´¨ï¼' },
        { id: 23, name: 'ğŸ é³³æ¢¨é…¥æ”»æ“Š', icon: 'ğŸ', msg: 'ä½ å¡äº†ä¸€å¡Šè¶…ç”œçš„é³³æ¢¨é…¥åˆ°å¯é”é´¨å˜´è£¡ï¼ç”œåˆ°ä»–ç‰™é½’ç—›ï¼' },
        { id: 24, name: 'ğŸ¦· è›€ç‰™æ”»æ“Š', icon: 'ğŸ˜·', msg: 'ä½ å°è‘—å¯é”é´¨å“ˆæ°£ï¼Œå‚³æŸ“äº†è›€ç‰™èŒï¼ä»–çš„ç‰™é½’é–‹å§‹ç—›äº†ï¼' },
        { id: 25, name: 'ğŸ’¯ 100å¼µæ•¸å­¸è€ƒå·', icon: 'ğŸ“œ', msg: 'ä½ ä¸Ÿå‡º100å¼µæ•¸å­¸è€ƒå·ï¼å¯é”é´¨çœ‹åˆ°å¯†å¯†éº»éº»çš„æ•¸å­—ç›´æ¥æšˆå€’ï¼' },
        { id: 26, name: 'ğŸ”§ æ‹”ç‰™æ”»æ“Š', icon: 'ğŸ”§', msg: 'ä½ æ‹¿å‡ºä¸€æŠŠå¤§æ¿æ‰‹è¦å¹«å¯é”é´¨æ‹”ç‰™ï¼ä»–åš‡å¾—è‡‰è‰²ç™¼ç™½ï¼' },
        { id: 27, name: 'ğŸ¹ é¦™æ¸¯è…³å¼“ç®­', icon: 'ğŸ¦¶', msg: 'ä½ æŠŠè‡­è¥ªå­ç¶åœ¨ç®­ä¸Šå°„å‡ºå»ï¼ç²¾æº–å‘½ä¸­ç´…å¿ƒï¼è‡­æ°£æ²–å¤©ï¼' },
        { id: 28, name: 'ğŸ¥” æ„›æƒ…æ´‹èŠ‹ç‰‡', icon: 'ğŸ§¡', msg: 'ä½ ä¸Ÿå‡ºä¸€ç‰‡æ„›å¿ƒå½¢ç‹€çš„æ´‹èŠ‹ç‰‡ï¼å¯é”é´¨åƒäº†è¦ºå¾—å¿ƒè£¡æš–æš–çš„...ç„¶å¾Œå°±è‚šå­ç—›äº†ï¼' }
    ];

    // --- å¯é”é´¨çš„åæ“Š ---
    const ENEMY_ATTACKS = [
        { name: 'é ­ç—›å…‰æ³¢', icon: 'âš¡', msg: 'å¯é”é´¨é ­ç—›äº†ï¼ç™¼å°„å‡ºå¥‡æ€ªçš„å…‰æ³¢ï¼' },
        { name: 'ç™¼å‘†å‡è¦–', icon: 'ğŸ‘€', msg: 'å¯é”é´¨ä¸€ç›´ç›¯è‘—ä½ çœ‹... ä½ è¦ºå¾—å¿ƒè£¡ç™¼æ¯›ï¼' },
        { name: 'æ»‘å€’æ’æ“Š', icon: 'ğŸ’«', msg: 'å¯é”é´¨ä¸å°å¿ƒæ»‘å€’ï¼Œæ•´å€‹äººæ’åœ¨ä½ èº«ä¸Šï¼' },
        { name: 'å™´æ°´æ”»æ“Š', icon: 'ğŸ’§', msg: 'å¯é”é´¨å™´äº†ä¸€å£æ°´åœ¨ä½ è‡‰ä¸Šï¼å¥½æ¿•å•Šï¼' },
        { name: 'å‘±å‘±å™ªéŸ³', icon: 'ğŸ¦†', msg: 'å¯é”é´¨å¤§å«ã€Œå‘±å‘±å‘±ã€ï¼åµæ­»äººäº†ï¼' },
        { name: 'æ”é ­å›°æƒ‘', icon: 'â“', msg: 'å¯é”é´¨æ­ªè‘—é ­... ä»–è‡ªå·±ä¹Ÿæä¸æ¸…æ¥šç‹€æ³ï¼Œä½†ä½ å—å‚·äº†ï¼' }
    ];

    let myChar = '';
    let myHp = 100;
    let enemyHp = 100;
    let curHour = 0;
    let curMin = 0;
    let forcedMistakeType = null;

    const canvas = document.getElementById('clockCanvas');
    const ctx = canvas.getContext('2d');
    const radius = canvas.height / 2;

    // --- åˆå§‹åŒ– (æ–°å¢è§’è‰²åˆ¤æ–·) ---
    function initGame(char) {
        myChar = char;
        const pImg = document.getElementById('char-player-img');
        const bgEl = document.getElementById('game-container');
        
        pImg.src = IMGS[char];
        // è¨­å®šä¸åŒè§’è‰²çš„èƒŒæ™¯å’Œå…‰ç’°
        if(char === 'snorlax') {
            pImg.classList.add('aura-snorlax'); bgEl.style.background = '#E3F2FD'; 
        } else if(char === 'mew') {
            pImg.classList.add('aura-mew'); bgEl.style.background = '#FCE4EC';
        } else if(char === 'pikachu') {
            pImg.classList.add('aura-pikachu'); bgEl.style.background = '#FFFACD'; // æ·¡é»ƒè‰²
        } else if(char === 'eevee') {
            pImg.classList.add('aura-eevee'); bgEl.style.background = '#FAF0E6'; // æ·¡è¤è‰²
        }

        document.getElementById('scene-select').classList.add('hidden');
        document.getElementById('scene-game').classList.remove('hidden');
        generateQuestion();
    }

    // --- æ”»æ“Šèˆ‡å‹•ç•«ç³»çµ± ---
    function generateAttacks() {
        let shuffled = [...ATTACK_POOL].sort(() => 0.5 - Math.random());
        let selected = shuffled.slice(0, 4);
        
        const grid = document.getElementById('attack-grid');
        grid.innerHTML = ''; 
        selected.forEach(atk => {
            let btn = document.createElement('button');
            btn.className = 'skill-btn';
            btn.innerHTML = `${atk.icon} ${atk.name}`;
            btn.onclick = () => performAttack(atk);
            grid.appendChild(btn);
        });
        document.getElementById('input-controls').style.display = 'none';
        grid.style.display = 'grid';
        document.getElementById('battle-log').innerHTML = "<span style='color:green'>âœ… ç­”å°äº†ï¼å¿«é¸ä¸€å€‹è¶…å¥½ç¬‘çš„æ‹›å¼ï¼</span>";
    }

    function performAttack(atk) {
        const grid = document.getElementById('attack-grid');
        grid.style.display = 'none';
        document.getElementById('battle-log').innerText = atk.msg;
        const player = document.getElementById('char-player-img');
        const enemy = document.getElementById('char-enemy-img');
        const projectile = document.getElementById('player-projectile');
        const dmgPopup = document.getElementById('damage-popup');

        player.classList.add('anim-lunge-right');
        projectile.innerText = atk.icon;
        setTimeout(() => projectile.classList.add('anim-shoot'), 100);

        setTimeout(() => {
            enemy.classList.add('anim-hit'); enemy.classList.add('filter-hurt');
            let dmg = 20 + Math.floor(Math.random()*10);
            dmgPopup.innerText = "-" + dmg; dmgPopup.style.display = 'block';
            enemyHp -= 20; 
            updateHp();
            setTimeout(() => {
                player.classList.remove('anim-lunge-right'); projectile.classList.remove('anim-shoot');
                enemy.classList.remove('anim-hit'); enemy.classList.remove('filter-hurt');
                dmgPopup.style.display = 'none';
                if(enemyHp <= 0) {
                    setTimeout(() => endGame(true), 800);
                } else {
                    document.getElementById('next-btn').style.display = 'block';
                    document.getElementById('battle-log').innerText = "å¯é”é´¨è¢«æ‰“æšˆäº†ï¼è¶å‹è¿½æ“Šï¼";
                }
            }, 1000);
        }, 600);
    }

    function enemyAttack() {
        const atk = ENEMY_ATTACKS[Math.floor(Math.random() * ENEMY_ATTACKS.length)];
        document.getElementById('battle-log').innerHTML = `<span style='color:#d32f2f'>${atk.msg}</span>`;
        const enemy = document.getElementById('char-enemy-img');
        const player = document.getElementById('char-player-img');
        const proj = document.getElementById('enemy-projectile');

        enemy.classList.add('anim-lunge-left');
        proj.innerText = atk.icon;
        setTimeout(() => proj.classList.add('anim-shoot-left'), 100);

        setTimeout(() => {
            player.classList.add('anim-hit'); player.classList.add('filter-hurt');
            myHp -= 20; updateHp();
            setTimeout(() => {
                enemy.classList.remove('anim-lunge-left'); proj.classList.remove('anim-shoot-left');
                player.classList.remove('anim-hit'); player.classList.remove('filter-hurt');
                if(myHp <= 0) setTimeout(() => endGame(false), 1000);
            }, 500);
        }, 300);
    }

    // --- æ™‚é˜é‚è¼¯ ---
    function generateQuestion() {
        if (forcedMistakeType === 'tricky_hour') {
            curHour = Math.floor(Math.random() * 12) + 1;
            curMin = 40 + Math.floor(Math.random() * 20); 
            document.getElementById('battle-log').innerHTML = "<span style='color:red'>ğŸ”¥ ç‰¹è¨“ï¼šçŸ­é‡å¿«ç¢°åˆ°ä¸‹å€‹æ•¸å­—äº†ï¼Œè¦å°å¿ƒï¼</span>";
        } else if (forcedMistakeType === 'minutes') {
            curHour = Math.floor(Math.random() * 12) + 1;
            curMin = Math.floor(Math.random() * 60);
            document.getElementById('battle-log').innerHTML = "<span style='color:red'>ğŸ”¥ ç‰¹è¨“ï¼šä»”ç´°æ•¸ä¸€æ•¸å°æ ¼å­ï¼</span>";
        } else {
            curHour = Math.floor(Math.random() * 12) + 1;
            if(Math.random() > 0.3) curMin = Math.floor(Math.random() * 12) * 5;
            else curMin = Math.floor(Math.random() * 60);
            document.getElementById('battle-log').innerText = "è«‹è¼¸å…¥ï¼šç¾åœ¨æ˜¯å¹¾é»å¹¾åˆ†ï¼Ÿ";
            document.getElementById('battle-log').style.color = "#333";
        }
        drawClock(curHour, curMin);
    }

    function drawClock(h, m) {
        ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.save(); ctx.translate(radius, radius);
        // éŒ¶ç›¤
        ctx.beginPath(); ctx.arc(0, 0, radius * 0.95, 0, 2*Math.PI); ctx.fillStyle = 'white'; ctx.fill();
        ctx.lineWidth = 8;
        // æ ¹æ“šè§’è‰²æ”¹è®ŠéŒ¶ç›¤é¡è‰²
        let strokeColor = '#4682B4'; // é è¨­å¡æ¯”ç¸è—
        if(myChar === 'mew') strokeColor = '#FF69B4';
        else if(myChar === 'pikachu') strokeColor = '#FFD700';
        else if(myChar === 'eevee') strokeColor = '#A0522D';
        ctx.strokeStyle = strokeColor; ctx.stroke();

        // åˆ»åº¦
        for(let i=0; i<60; i++) {
            let ang = i * Math.PI / 30; let isMajor = (i % 5 === 0);
            ctx.beginPath();
            if (isMajor) {
                ctx.lineWidth = 4; ctx.strokeStyle = "#333";
                ctx.moveTo(radius*0.80 * Math.sin(ang), -radius*0.80 * Math.cos(ang));
                ctx.lineTo(radius*0.92 * Math.sin(ang), -radius*0.92 * Math.cos(ang));
            } else {
                ctx.lineWidth = 1.5; ctx.strokeStyle = "#999";
                ctx.moveTo(radius*0.85 * Math.sin(ang), -radius*0.85 * Math.cos(ang));
                ctx.lineTo(radius*0.92 * Math.sin(ang), -radius*0.92 * Math.cos(ang));
            }
            ctx.stroke();
        }
        // æ•¸å­—
        ctx.font = "bold " + (radius*0.15) + "px Arial"; ctx.textBaseline="middle"; ctx.textAlign="center"; ctx.fillStyle = '#333';
        for(let num = 1; num <= 12; num++){
            let ang = num * Math.PI / 6;
            ctx.fillText(num.toString(), radius*0.68 * Math.sin(ang), -radius*0.68 * Math.cos(ang));
        }
        // æŒ‡é‡
        let mAng = (m * Math.PI / 30); let hAng = (h % 12 * Math.PI / 6) + (mAng / 12);
        ctx.beginPath(); ctx.lineWidth = 9; ctx.lineCap = "round"; ctx.strokeStyle = '#333'; // æ™‚é‡
        ctx.moveTo(0,0); ctx.rotate(hAng); ctx.lineTo(0, -radius*0.45); ctx.stroke(); ctx.rotate(-hAng);
        ctx.beginPath(); ctx.lineWidth = 5; ctx.lineCap = "round"; ctx.strokeStyle = '#d32f2f'; // åˆ†é‡
        ctx.moveTo(0,0); ctx.rotate(mAng); ctx.lineTo(0, -radius*0.70); ctx.stroke(); ctx.rotate(-mAng);
        ctx.beginPath(); ctx.arc(0, 0, 8, 0, 2*Math.PI); ctx.fillStyle = '#333'; ctx.fill(); // ä¸­å¿ƒ
        ctx.beginPath(); ctx.arc(0, 0, 4, 0, 2*Math.PI); ctx.fillStyle = '#d32f2f'; ctx.fill();
        ctx.restore();
    }

    function checkAnswer() {
        const inH = parseInt(document.getElementById('in-hour').value);
        const inM = parseInt(document.getElementById('in-min').value);
        if(isNaN(inH) || isNaN(inM)) return;
        if(inH === curHour && inM === curMin) {
            generateAttacks(); forcedMistakeType = null;
        } else {
            analyzeError(inH, inM);
        }
    }

    function analyzeError(userH, userM) {
        let html = "";
        let isTrickyHour = (curMin >= 40); 
        if (isTrickyHour && userH === (curHour % 12) + 1) {
            html += `<p>ä½ æŠŠæ™‚é‡çœ‹æˆ <span class="highlight-red">${userH}</span> äº†å—ï¼Ÿ</p>`;
            html += `<p>âš ï¸ é›–ç„¶å¾ˆåƒï¼Œä½†é•·é‡é‚„æ²’èµ°åˆ°12ï¼Œæ‰€ä»¥ç¾åœ¨é‚„æ˜¯ <span class="highlight-blue">${curHour} é»å¤š</span>å–”ï¼</p>`;
            forcedMistakeType = 'tricky_hour';
        } else if (userM !== curMin) {
            let nearestBig = Math.floor(curMin / 5);
            html += `<p>åˆ†é‡æ•¸éŒ¯å›‰ã€‚å…ˆçœ‹ç¶“éçš„å¤§æ•¸å­— <b>${nearestBig}</b>ã€‚</p>`;
            html += `<p>${nearestBig} x 5 = ${nearestBig*5}ï¼Œç„¶å¾Œå†æ•¸å°æ ¼å­ï¼š${nearestBig*5+1}... åˆ° <span class="highlight-blue">${curMin}</span>ï¼</p>`;
            forcedMistakeType = 'minutes';
        } else {
            html += `<p>æ­£ç¢ºç­”æ¡ˆæ˜¯ <span class="highlight-blue">${curHour} é» ${curMin} åˆ†</span>ã€‚</p>`;
            html += `<p>å†ä»”ç´°çœ‹ä¸€ä¸‹å–”ï¼</p>`;
            forcedMistakeType = null;
        }
        document.getElementById('tutorial-text').innerHTML = html;
        document.getElementById('tutorial-overlay').style.display = 'block';
        enemyAttack();
    }

    function closeTutorial() {
        document.getElementById('tutorial-overlay').style.display = 'none';
        document.getElementById('in-hour').value = ''; document.getElementById('in-min').value = '';
        document.getElementById('in-hour').focus(); document.getElementById('battle-log').innerText = "å†è©¦ä¸€æ¬¡ï¼";
    }

    function nextRound() {
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('input-controls').style.display = 'block';
        document.getElementById('in-hour').value = ''; document.getElementById('in-min').value = '';
        generateQuestion();
    }

    function updateHp() {
        document.getElementById('hp-player').style.width = Math.max(0, myHp) + '%';
        document.getElementById('hp-enemy').style.width = Math.max(0, enemyHp) + '%';
    }

    function endGame(win) {
        document.getElementById('scene-game').classList.add('hidden');
        document.getElementById('end-screen').style.display = 'block';
        const img = document.getElementById('end-img');
        if(win) {
            document.getElementById('end-title').innerText = "ğŸ‰ æŒ‘æˆ°æˆåŠŸï¼";
            img.src = IMGS.win; 
            document.getElementById('end-desc').innerText = "ä½ å¤ªå²å®³äº†ï¼å¯é”é´¨å®Œå…¨è¢«æ‰“æ•—äº†ï¼";
        } else {
            document.getElementById('end-title').innerText = "ğŸ˜¢ æŒ‘æˆ°å¤±æ•—...";
            img.src = IMGS.lose;
            document.getElementById('end-desc').innerText = "æ²’é—œä¿‚ï¼Œå¤šç·´ç¿’å¹¾æ¬¡ï¼Œä¸‹æ¬¡ä¸€å®šæœƒè´ï¼";
        }
    }
</script>
</body>
</html>